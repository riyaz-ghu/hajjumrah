import{u as xe,r as l,j as e}from"./index-o6bFHvLj.js";import{L as fe}from"./index-BturGVvf.js";import{C as be,a as ve,B as M,s as p}from"./supabase-fagYWzpQ.js";import{S as J}from"./search-CuF8U8EO.js";const je=["air ticket","umrah visa","insurance","hotel accommodation","food","transport","ziyarat","umrah kit","laundry","zamzam","tour guide"],ye=["sim card","ziyarat taif","ziyarat badar"],Me=()=>{var $,B;const I=xe(),[w,Q]=l.useState([]),[X,Z]=l.useState([]),[C,ee]=l.useState(null),[A,ae]=l.useState(null),[N,P]=l.useState(!1),[f,E]=l.useState(""),[se,S]=l.useState(""),[te,_]=l.useState(""),[H,b]=l.useState([]),[L,v]=l.useState([]),[re,z]=l.useState(!1),[ie,D]=l.useState(!1),[o,F]=l.useState(null),[d,T]=l.useState(null),[R,j]=l.useState(""),[n,u]=l.useState({operatorId:"",name:"",packageType:"Economy",duration:0,airlineId:"",meccaHotelId:"",madinaHotelId:"",inclusions:{standard:[],special:[],custom:[]}});l.useEffect(()=>{(async()=>{const{data:s}=await p.from("ghu_operators").select("id, name, city");Q(s||[])})()},[]),l.useEffect(()=>{if(n.operatorId){const a=w.find(s=>s.id===n.operatorId);a&&(async()=>{const{data:i}=await p.from("ghu_airlines").select("id, name, departure_city").eq("departure_city",a.city);Z(i||[])})()}},[n.operatorId,w]),l.useEffect(()=>{(async()=>{const s=new fe({apiKey:"AIzaSyCWh1e1w6S7Y0MCt4yo_68kSUUsILnDM5E",version:"weekly",libraries:["places"]});try{await s.load();const i=new google.maps.Map(document.createElement("div"));ee(new google.maps.places.PlacesService(i)),ae(new google.maps.places.AutocompleteService)}catch(i){console.error("Error loading Google Places API:",i)}})()},[]);const q=async(a,s)=>{if(!A||a.length<3){s==="Mecca"?b([]):v([]);return}s==="Mecca"?z(!0):D(!0);try{const t=(await A.getPlacePredictions({input:`${a} hotel in ${s}`,componentRestrictions:{country:"SA"},types:["lodging"]})).predictions.map(h=>({place_id:h.place_id,description:h.description}));s==="Mecca"?b(t):v(t)}catch(i){console.error("Error fetching hotel suggestions:",i)}finally{s==="Mecca"?z(!1):D(!1)}},O=async(a,s)=>{var i;if(C)try{const t=await new Promise((r,c)=>{C.getDetails({placeId:a,fields:["name","rating","user_ratings_total","formatted_address","photos","place_id","geometry","types","reviews"]},(m,x)=>{x===google.maps.places.PlacesServiceStatus.OK&&m?r(m):c(new Error(`Place details request failed: ${x}`))})});let h=0;if((i=t.geometry)!=null&&i.location){const r={Mecca:{lat:21.422487,lng:39.826206},Madina:{lat:24.467428,lng:39.611471}},c=t.geometry.location.lat(),m=t.geometry.location.lng(),x=r[s].lat,he=r[s].lng,ge=6371,G=(x-c)*Math.PI/180,V=(he-m)*Math.PI/180,Y=Math.sin(G/2)*Math.sin(G/2)+Math.cos(c*Math.PI/180)*Math.cos(x*Math.PI/180)*Math.sin(V/2)*Math.sin(V/2),pe=2*Math.atan2(Math.sqrt(Y),Math.sqrt(1-Y));h=+(ge*pe).toFixed(2)}const oe=["restaurant","parking","gym","spa","room_service","wifi","airport_shuttle"],de=(Array.isArray(t.types)?t.types.filter(r=>typeof r=="string"):[]).filter(r=>oe.includes(r)),me={restaurant:"Restaurant",parking:"Parking",gym:"Fitness Center",spa:"Spa",room_service:"Room Service",wifi:"WiFi",airport_shuttle:"Airport Shuttle"},K=de.map(r=>me[r]);t.rating&&t.rating>=4&&K.push("24/7 Front Desk","Concierge Service");const W=[];if(t.photos&&Array.isArray(t.photos))for(let r=0;r<Math.min(t.photos.length,5);r++){const c=t.photos[r];if(c&&typeof c.getUrl=="function")try{const m=c.getUrl();typeof m=="string"&&W.push(m)}catch(m){console.warn("Failed to get photo URL:",m)}}const y=[];t.reviews&&Array.isArray(t.reviews)&&t.reviews.slice(0,5).forEach(c=>{c&&y.push({review:c.text||"",date:c.time?new Date(c.time*1e3).toISOString():new Date().toISOString(),name:c.author_name||"Anonymous",rating:c.rating||0})});const ue={name:t.name||"",rating:typeof t.rating=="number"?t.rating:0,reviews_count:typeof t.user_ratings_total=="number"?t.user_ratings_total:0,images:W,amenities:K,place_id:t.place_id||"",city:s,distance_to_haram:h,user_review:y},{data:g,error:k}=await p.from("ghu_hotels").insert(ue).select().single();if(k){if(k.code==="23505"){const{data:r,error:c}=await p.from("ghu_hotels").select("*").eq("place_id",a).maybeSingle();if(c)throw c;if(!r)throw new Error("Failed to fetch existing hotel");if(!r.user_review&&y.length>0){const{error:m}=await p.from("ghu_hotels").update({user_review:y}).eq("place_id",a);m&&console.warn("Failed to update existing hotel with reviews:",m)}s==="Mecca"?(F(r),S(r.name),b([])):(T(r),_(r.name),v([])),u(m=>({...m,[s==="Mecca"?"meccaHotelId":"madinaHotelId"]:r.id}));return}throw k}g&&(s==="Mecca"?(F(g),S(g.name),b([])):(T(g),_(g.name),v([])),u(r=>({...r,[s==="Mecca"?"meccaHotelId":"madinaHotelId"]:g.id})))}catch(t){console.error("Error selecting hotel:",t),j("Failed to select hotel. Please try again.")}},U=(a,s)=>{u(i=>({...i,inclusions:{...i.inclusions,[a]:i.inclusions[a].includes(s)?i.inclusions[a].filter(t=>t!==s):[...i.inclusions[a],s]}}))},ne=()=>{f.trim()&&(u(a=>({...a,inclusions:{...a.inclusions,custom:[...a.inclusions.custom,f.trim()]}})),E(""))},le=()=>!n.meccaHotelId||!n.madinaHotelId?(j("Please select both Mecca and Madina hotels before submitting"),!1):(j(""),!0),ce=async a=>{if(a.preventDefault(),!!le()){P(!0);try{const{data:s,error:i}=await p.from("ghu_packages").insert({operator_id:n.operatorId,name:n.name,package_type:n.packageType,duration:n.duration,airline_id:n.airlineId,mecca_hotel_id:n.meccaHotelId,madina_hotel_id:n.madinaHotelId,inclusions:n.inclusions}).select();if(i)throw i;I("/packages")}catch(s){console.error("Error saving package:",s),j("Failed to save package. Please try again.")}finally{P(!1)}}};return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(be,{className:"max-w-2xl mx-auto",children:e.jsx(ve,{children:e.jsxs("form",{onSubmit:ce,className:"space-y-6",children:[e.jsx("h2",{className:"text-2xl font-poppins font-semibold text-black mb-6",children:"Add New Package"}),R&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6",children:R}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-2",children:"Select Operator"}),e.jsxs("select",{value:n.operatorId,onChange:a=>u(s=>({...s,operatorId:a.target.value})),className:"w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:border-transparent",required:!0,children:[e.jsx("option",{value:"",children:"Select an operator"}),w.map(a=>e.jsxs("option",{value:a.id,children:[a.name," (",a.city,")"]},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-2",children:"Package Name"}),e.jsx("input",{type:"text",value:n.name,onChange:a=>u(s=>({...s,name:a.target.value})),className:"w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:border-transparent",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-2",children:"Package Type"}),e.jsxs("select",{value:n.packageType,onChange:a=>u(s=>({...s,packageType:a.target.value})),className:"w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:border-transparent",required:!0,children:[e.jsx("option",{value:"Economy",children:"Economy"}),e.jsx("option",{value:"Comfort",children:"Comfort"}),e.jsx("option",{value:"Premium",children:"Premium"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-2",children:"Duration (days)"}),e.jsx("input",{type:"number",value:n.duration,onChange:a=>u(s=>({...s,duration:parseInt(a.target.value)})),className:"w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:border-transparent",min:"1",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-2",children:"Select Airline"}),e.jsxs("select",{value:n.airlineId,onChange:a=>u(s=>({...s,airlineId:a.target.value})),className:"w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:border-transparent",required:!0,disabled:!n.operatorId,children:[e.jsx("option",{value:"",children:"Select an airline"}),X.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-2",children:"Search Mecca Hotel"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:se,onChange:a=>{S(a.target.value),q(a.target.value,"Mecca")},placeholder:"Search for hotel in Mecca...",className:"w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:border-transparent"}),re?e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-primary border-t-transparent"})}):e.jsx(J,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:20})]}),H.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto",children:H.map(a=>e.jsx("button",{type:"button",onClick:()=>O(a.place_id,"Mecca"),className:"w-full p-3 text-left hover:bg-gray border-b last:border-b-0",children:a.description},a.place_id))}),o&&e.jsxs("div",{className:"mt-2 p-3 bg-gray rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[(($=o.images)==null?void 0:$[0])&&e.jsx("img",{src:o.images[0],alt:o.name,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:o.name}),e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsxs("span",{children:["Rating: ",o.rating]}),e.jsx("span",{className:"mx-2",children:"â€¢"}),e.jsxs("span",{children:[o.reviews_count," reviews"]})]}),e.jsx("div",{className:"text-sm text-gray-600",children:e.jsxs("span",{children:[o.distance_to_haram,"km from Haram"]})}),o.user_review&&o.user_review.length>0&&e.jsx("div",{className:"text-sm text-gray-600",children:e.jsxs("span",{children:[o.user_review.length," user reviews fetched"]})})]})]}),o.amenities&&o.amenities.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Amenities:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:o.amenities.map((a,s)=>e.jsx("span",{className:"inline-block px-2 py-1 text-xs bg-white rounded-full text-gray-600",children:a},s))})]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-2",children:"Search Madina Hotel"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:te,onChange:a=>{_(a.target.value),q(a.target.value,"Madina")},placeholder:"Search for hotel in Madina...",className:"w-full p-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:border-transparent"}),ie?e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-primary border-t-transparent"})}):e.jsx(J,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:20})]}),L.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto",children:L.map(a=>e.jsx("button",{type:"button",onClick:()=>O(a.place_id,"Madina"),className:"w-full p-3 text-left hover:bg-gray border-b last:border-b-0",children:a.description},a.place_id))}),d&&e.jsxs("div",{className:"mt-2 p-3 bg-gray rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[((B=d.images)==null?void 0:B[0])&&e.jsx("img",{src:d.images[0],alt:d.name,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:d.name}),e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsxs("span",{children:["Rating: ",d.rating]}),e.jsx("span",{className:"mx-2",children:"â€¢"}),e.jsxs("span",{children:[d.reviews_count," reviews"]})]}),e.jsx("div",{className:"text-sm text-gray-600",children:e.jsxs("span",{children:[d.distance_to_haram,"km from Haram"]})}),d.user_review&&d.user_review.length>0&&e.jsx("div",{className:"text-sm text-gray-600",children:e.jsxs("span",{children:[d.user_review.length," user reviews fetched"]})})]})]}),d.amenities&&d.amenities.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Amenities:"}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:d.amenities.map((a,s)=>e.jsx("span",{className:"inline-block px-2 py-1 text-xs bg-white rounded-full text-gray-600",children:a},s))})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-black mb-4",children:"Standard Inclusions"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:je.map(a=>e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:n.inclusions.standard.includes(a),onChange:()=>U("standard",a),className:"rounded border-gray-300 text-primary focus:ring-primary"}),e.jsx("span",{className:"text-sm",children:a})]},a))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-black mb-4",children:"Special Inclusions"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:ye.map(a=>e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:n.inclusions.special.includes(a),onChange:()=>U("special",a),className:"rounded border-gray-300 text-primary focus:ring-primary"}),e.jsx("span",{className:"text-sm",children:a})]},a))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-black mb-4",children:"Custom Inclusions"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("input",{type:"text",value:f,onChange:a=>E(a.target.value),className:"flex-1 p-2 border rounded-lg bg-white focus:ring-2 focus:ring-primary focus:border-transparent",placeholder:"Add custom inclusion..."}),e.jsx(M,{type:"button",onClick:ne,disabled:!f.trim(),children:"Add"})]}),n.inclusions.custom.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:n.inclusions.custom.map((a,s)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray p-2 rounded-lg",children:[e.jsx("span",{children:a}),e.jsx("button",{type:"button",onClick:()=>u(i=>({...i,inclusions:{...i.inclusions,custom:i.inclusions.custom.filter((t,h)=>h!==s)}})),className:"text-red-500 hover:text-red-700",children:"Remove"})]},s))})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(M,{variant:"outline",onClick:()=>I("/packages"),disabled:N,children:"Cancel"}),e.jsx(M,{type:"submit",disabled:N,children:N?"Saving...":"Save Package"})]})]})})})})};export{Me as default};
